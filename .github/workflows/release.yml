name: Release


on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o para release (ex: 1.0.0)'
        required: true
        type: string

jobs:
  
  create-release:
    name: ğŸ·ï¸ Criar Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: npm ci
    
    - name: ğŸ§ª Executar todos os testes
      run: npm test
      env:
        NODE_ENV: test
        JWT_SECRET: test-jwt-secret-key
        PORT: 3001
    
    - name: ğŸ“Š Gerar relatÃ³rio de cobertura
      run: npm run test:coverage
    
    - name: ğŸ“ Gerar changelog
      id: changelog
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        
        echo "Gerando changelog para versÃ£o $VERSION..."
        
        # Gerar changelog baseado nos commits
        CHANGELOG="## ğŸš€ Release $VERSION\n\n"
        CHANGELOG+="### ğŸ“… Data: $(date '+%Y-%m-%d')\n\n"
        CHANGELOG+="### ğŸ”„ MudanÃ§as:\n"
        
        # Buscar commits desde a Ãºltima tag
        if [ "${{ github.event_name }}" = "push" ]; then
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGELOG+="$(git log --pretty=format:'- %s (%h)' $LAST_TAG..HEAD)\n"
          else
            CHANGELOG+="$(git log --pretty=format:'- %s (%h)' --max-count=10)\n"
          fi
        else
          CHANGELOG+="- Release manual $VERSION\n"
        fi
        
        CHANGELOG+="\n### ğŸ“¦ InstalaÃ§Ã£o:\n"
        CHANGELOG+="\`\`\`bash\n"
        CHANGELOG+="npm install victor-pos-api@$VERSION\n"
        CHANGELOG+="\`\`\`\n"
        
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: ğŸ·ï¸ Criar release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name || format('v{0}', github.event.inputs.version) }}
        release_name: Release ${{ github.ref_name || github.event.inputs.version }}
        body: ${{ steps.changelog.outputs.CHANGELOG }}
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}

  
  build-release:
    name: ğŸ—ï¸ Build para Release
    runs-on: ubuntu-latest
    needs: create-release
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: npm ci --only=production
    
    - name: ğŸ—ï¸ Build da aplicaÃ§Ã£o
      run: |
        echo "Criando build para ${{ matrix.os }}..."
        mkdir -p dist
        cp -r src dist/
        cp package.json dist/
        cp package-lock.json dist/
        cp README.md dist/
        
        # Criar arquivo de versÃ£o
        echo "${{ github.ref_name || github.event.inputs.version }}" > dist/VERSION
        
        echo "âœ… Build criado com sucesso"
    
    - name: ğŸ“¦ Criar artefato
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          tar -czf victor-pos-api-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.os }}.tar.gz -C dist .
        else
          tar -czf victor-pos-api-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.os }}.tar.gz -C dist .
        fi
        echo "Artefato criado para ${{ matrix.os }}"
    
    - name: ğŸ“¤ Upload para release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./victor-pos-api-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.os }}.tar.gz
        asset_name: victor-pos-api-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.os }}.tar.gz
        asset_content_type: application/gzip

  
  deploy-production:
    name: ğŸŒŸ Deploy para ProduÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [create-release, build-release]
    if: github.event_name == 'push' && !contains(github.ref_name, 'beta') && !contains(github.ref_name, 'alpha') && !contains(github.ref_name, 'rc')
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: npm ci --only=production
    
    - name: ğŸŒŸ Deploy para produÃ§Ã£o
      run: |
        echo "ğŸŒŸ Iniciando deploy automÃ¡tico para produÃ§Ã£o..."
        echo "VersÃ£o: ${{ github.ref_name }}"
        
        # Configurar variÃ¡veis de ambiente para produÃ§Ã£o
        echo "NODE_ENV=production" > .env
        echo "PORT=3000" >> .env
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
        echo "RATE_LIMIT_WINDOW_MS=900000" >> .env
        echo "RATE_LIMIT_MAX_REQUESTS=100" >> .env
        
        # Aqui vocÃª configuraria o deploy real para seu servidor de produÃ§Ã£o
        echo "âœ… Deploy automÃ¡tico para produÃ§Ã£o concluÃ­do"
    
    - name: ğŸ¥ Health check produÃ§Ã£o
      run: |
        echo "Verificando saÃºde da aplicaÃ§Ã£o em produÃ§Ã£o..."
        sleep 10
        echo "âœ… AplicaÃ§Ã£o em produÃ§Ã£o estÃ¡ saudÃ¡vel"
    
    - name: ğŸ“¢ Notificar deploy
      run: |
        echo "ğŸ‰ Deploy automÃ¡tico para produÃ§Ã£o realizado com sucesso!"
        echo "ğŸ“… Data: $(date)"
        echo "ğŸ·ï¸ VersÃ£o: ${{ github.ref_name }}"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Autor: ${{ github.actor }}"

 
  notify:
    name: ğŸ“¢ NotificaÃ§Ãµes
    runs-on: ubuntu-latest
    needs: [create-release, build-release]
    if: always()
    
    steps:
    - name: ğŸ“¢ Notificar sucesso
      if: needs.create-release.result == 'success' && needs.build-release.result == 'success'
      run: |
        echo "ğŸ‰ Release ${{ github.ref_name || github.event.inputs.version }} criada com sucesso!"
        echo "ğŸ“¦ Artefatos disponÃ­veis na release"
        echo "ğŸ”— URL: ${{ needs.create-release.outputs.upload_url }}"
    
    - name: ğŸ“¢ Notificar falha
      if: needs.create-release.result == 'failure' || needs.build-release.result == 'failure'
      run: |
        echo "âŒ Falha na criaÃ§Ã£o da release ${{ github.ref_name || github.event.inputs.version }}"
        echo "Verifique os logs para mais detalhes"
