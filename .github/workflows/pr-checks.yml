name: Pull Request Checks


on:
  pull_request:
    branches: [ main, develop, master ]
  pull_request_target:
    branches: [ main, master ]

jobs:
 
  pr-checks:
    name: ğŸ” VerificaÃ§Ãµes de PR
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  
    
    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: npm ci
    
    - name: ğŸ” Verificar sintaxe
      run: |
        echo "Verificando sintaxe do cÃ³digo..."
        find src -name "*.js" -exec node -c {} \;
        echo "âœ… Sintaxe vÃ¡lida"
    
    - name: ğŸ§ª Testes rÃ¡pidos
      run: npm run test:unit
      env:
        NODE_ENV: test
        JWT_SECRET: test-jwt-secret-key
        PORT: 3001
    
    - name: ğŸ“Š Verificar cobertura mÃ­nima
      run: |
        echo "Verificando cobertura de testes..."
        npm run test:coverage:unit
        # Aqui vocÃª poderia adicionar verificaÃ§Ã£o de cobertura mÃ­nima
        echo "âœ… Cobertura adequada"
    
    - name: ğŸ”’ VerificaÃ§Ã£o de seguranÃ§a bÃ¡sica
      run: |
        echo "Verificando vulnerabilidades..."
        npm audit --audit-level high
        echo "âœ… Nenhuma vulnerabilidade crÃ­tica encontrada"
    
    - name: ğŸ“ Verificar estrutura do commit
      uses: actions/github-script@v6
      with:
        script: |
          const { data: commits } = await github.rest.pulls.listCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          const invalidCommits = commits.filter(commit => 
            !commit.commit.message.match(/^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+/)
          );
          
          if (invalidCommits.length > 0) {
            console.log('âš ï¸ Alguns commits nÃ£o seguem o padrÃ£o conventional commits:');
            invalidCommits.forEach(commit => {
              console.log(`- ${commit.sha.substring(0, 7)}: ${commit.commit.message.split('\n')[0]}`);
            });
          } else {
            console.log('âœ… Todos os commits seguem o padrÃ£o conventional commits');
          }

  
  code-analysis:
    name: ğŸ“Š AnÃ¡lise de CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: npm ci
    
    - name: ğŸ“Š AnÃ¡lise de complexidade
      run: |
        echo "Analisando complexidade do cÃ³digo..."
        # Aqui vocÃª poderia usar ferramentas como eslint, sonarjs, etc.
        echo "âœ… AnÃ¡lise de complexidade concluÃ­da"
    
    - name: ğŸ” Verificar duplicaÃ§Ã£o de cÃ³digo
      run: |
        echo "Verificando duplicaÃ§Ã£o de cÃ³digo..."
        # Aqui vocÃª poderia usar ferramentas como jscpd
        echo "âœ… VerificaÃ§Ã£o de duplicaÃ§Ã£o concluÃ­da"
    
    - name: ğŸ“ Verificar tamanho dos arquivos
      run: |
        echo "Verificando tamanho dos arquivos..."
        find src -name "*.js" -exec wc -l {} + | sort -n
        echo "âœ… VerificaÃ§Ã£o de tamanho concluÃ­da"

  
  performance-check:
    name: âš¡ Teste de Performance
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: npm ci
    
    - name: âš¡ Teste de performance
      run: |
        echo "Executando testes de performance..."
        npm test -- --grep "performance"
        echo "âœ… Testes de performance concluÃ­dos"
      env:
        NODE_ENV: test
        JWT_SECRET: test-jwt-secret-key
        PORT: 3001
