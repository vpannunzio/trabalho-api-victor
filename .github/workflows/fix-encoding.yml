name: Fix Encoding Issues

on:
  workflow_dispatch:
    inputs:
      fix_path_encoding:
        description: 'Corrigir problemas de codificaÃ§Ã£o de caminho'
        required: true
        default: true
        type: boolean

jobs:
  fix-encoding:
    name: ğŸ”§ Corrigir Problemas de CodificaÃ§Ã£o
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      with:
        # ForÃ§a o uso de LF para todos os arquivos
        lfs: false
    
    - name: ğŸ”§ Configurar Git para UTF-8
      run: |
        echo "Configurando Git para usar UTF-8..."
        git config --global core.autocrlf false
        git config --global core.eol lf
        git config --global core.quotepath false
        git config --global core.precomposeunicode true
        echo "âœ… ConfiguraÃ§Ã£o do Git atualizada"
    
    - name: ğŸ” Verificar codificaÃ§Ã£o dos arquivos
      run: |
        echo "Verificando codificaÃ§Ã£o dos arquivos principais..."
        file -bi src/app.js
        file -bi package.json
        file -bi README.md
        echo "âœ… VerificaÃ§Ã£o de codificaÃ§Ã£o concluÃ­da"
    
    - name: ğŸ”„ Normalizar quebras de linha
      run: |
        echo "Normalizando quebras de linha..."
        find . -type f -name "*.js" -o -name "*.json" -o -name "*.md" -o -name "*.yml" -o -name "*.yaml" | \
        xargs dos2unix 2>/dev/null || true
        echo "âœ… Quebras de linha normalizadas"
    
    - name: ğŸ“ Verificar estrutura do projeto
      run: |
        echo "Verificando estrutura do projeto..."
        echo "DiretÃ³rio atual: $(pwd)"
        echo "ConteÃºdo do diretÃ³rio:"
        ls -la
        echo "âœ… Estrutura verificada"
    
    - name: ğŸ§ª Testar execuÃ§Ã£o do projeto
      run: |
        echo "Testando execuÃ§Ã£o do projeto..."
        node --version
        npm --version
        echo "Verificando sintaxe do arquivo principal..."
        node -c src/app.js
        echo "âœ… Projeto pode ser executado corretamente"
    
    - name: ğŸ’¾ Commit das correÃ§Ãµes
      if: github.event.inputs.fix_path_encoding == 'true'
      run: |
        echo "Fazendo commit das correÃ§Ãµes de codificaÃ§Ã£o..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git diff --staged --quiet || git commit -m "ğŸ”§ Fix encoding issues and normalize line endings"
        echo "âœ… CorreÃ§Ãµes commitadas"
